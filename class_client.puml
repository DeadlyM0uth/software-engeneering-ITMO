@startuml

title Диаграмма классов клиентской части приложения

package "Client Application" {
    class App {
        - router: Router
        - authService: AuthService
        - wsClient: WebSocketClient
        + initialize(): void
        + run(): void
    }

    class Router {
        - routes: Map<string, Component>
        - currentRoute: string
        + navigate(path: string): void
        + registerRoute(path: string, component: Component): void
        - renderComponent(component: Component): void
    }

    abstract class Component {
        # state: any
        # props: any
        + render(): HTMLElement
        + mount(container: HTMLElement): void
        + unmount(): void
        # setState(newState: any): void
    }
}

package "Authentication" {
    class AuthService {
        - token: string
        - currentUser: User
        + login(email: string, password: string): Promise<User>
        + logout(): void
        + register(userData: RegisterData): Promise<User>
        + getCurrentUser(): User
        + isAuthenticated(): boolean
        + getToken(): string
    }

    class User {
        + id: UUID
        + email: String
        + name: String
        + createdAt: DateTime
        + updatedAt: DateTime
    }
}

package "WebSocket Client" {
    class WebSocketClient {
        - socket: WebSocket
        - url: string
        - reconnectAttempts: int
        - messageQueue: Message[]
        - listeners: Map<MessageType, Function[]>
        + connect(token: string): Promise<void>
        + disconnect(): void
        + send(message: Message): void
        + on(type: MessageType, callback: Function): void
        + off(type: MessageType, callback: Function): void
        - handleMessage(event: MessageEvent): void
        - handleReconnect(): void
    }

    class ReconnectionManager {
        - maxAttempts: int
        - currentAttempt: int
        - backoffDelay: int
        + shouldReconnect(): boolean
        + getNextDelay(): int
        + reset(): void
    }
}

package "Project Management" {
    class ProjectService {
        - apiClient: ApiClient
        + getProjects(): Promise<Project[]>
        + getProject(id: UUID): Promise<Project>
        + createProject(data: ProjectData): Promise<Project>
        + updateProject(id: UUID, data: ProjectData): Promise<Project>
        + deleteProject(id: UUID): Promise<void>
        + inviteUser(projectId: UUID, email: String): Promise<void>
    }

    class Project {
        + id: UUID
        + name: String
        + description: String
        + ownerId: UUID
        + participants: Participant[]
        + createdAt: DateTime
        + updatedAt: DateTime
    }

    class Participant {
        + userId: UUID
        + userName: String
        + role: ParticipantRole
        + joinedAt: DateTime
    }

    enum ParticipantRole {
        OWNER
        EDITOR
        VIEWER
    }
}

package "Collaborative Editing" {
    class EditorController {
        - canvas: Canvas
        - selectionManager: SelectionManager
        - syncService: SyncService
        - toolManager: ToolManager
        + initialize(projectId: UUID): void
        + handleUserInput(event: InputEvent): void
        + applyRemoteChange(change: ChangeDelta): void
    }

    class Canvas {
        - objects: Map<UUID, CanvasObject>
        - viewport: Viewport
        - renderer: Renderer
        + addObject(object: CanvasObject): void
        + removeObject(id: UUID): void
        + updateObject(id: UUID, properties: JSON): void
        + render(): void
        + clear(): void
    }

    class CanvasObject {
        + id: UUID
        + projectId: UUID
        + type: String
        + data: JSON
        + positionX: Float
        + positionY: Float
        + createdBy: UUID
        + createdAt: DateTime
        + updatedAt: DateTime
        + render(ctx: RenderingContext): void
        + getBounds(): Rectangle
    }

    enum ObjectType {
        RECTANGLE
        CIRCLE
        LINE
        TEXT
        IMAGE
        GROUP
    }

    class SelectionManager {
        - selectedObjects: Set<UUID>
        + select(objectId: UUID): void
        + deselect(objectId: UUID): void
        + clearSelection(): void
        + getSelected(): UUID[]
        + isSelected(objectId: UUID): boolean
    }

    class ToolManager {
        - activeTool: Tool
        - tools: Map<String, Tool>
        + setActiveTool(toolName: String): void
        + getActiveTool(): Tool
        + registerTool(name: String, tool: Tool): void
    }

    abstract class Tool {
        # name: String
        + onMouseDown(event: MouseEvent): void
        + onMouseMove(event: MouseEvent): void
        + onMouseUp(event: MouseEvent): void
        + onKeyDown(event: KeyboardEvent): void
    }

    class SyncService {
        - wsClient: WebSocketClient
        - localChanges: ChangeDelta[]
        - pendingChanges: ChangeDelta[]
        - otClient: OTClient
        + sendChange(change: ChangeDelta): void
        + receiveChange(change: ChangeDelta): void
        + synchronize(): void
        - applyLocalChange(change: ChangeDelta): void
        - applyRemoteChange(change: ChangeDelta): void
    }

    class OTClient {
        - state: JSON
        - serverRevision: int
        - pendingOps: ChangeDelta[]
        + applyClient(op: ChangeDelta): void
        + applyServer(op: ChangeDelta): void
        + transform(op1: ChangeDelta, op2: ChangeDelta): ChangeDelta[]
    }

    class ChangeDelta {
        + type: String
        + objectId: UUID
        + data: JSON
        + timestamp: DateTime
        + userId: UUID
    }

    class PresenceService {
        - wsClient: WebSocketClient
        - users: Map<UUID, RemoteUser>
        + updateCursor(position: CursorPosition): void
        + updateStatus(status: PresenceStatus): void
        + getActiveUsers(): RemoteUser[]
        - handlePresenceUpdate(data: PresenceInfo): void
    }

    class RemoteUser {
        + userId: UUID
        + userName: String
        + cursor: CursorPosition
        + selection: UUID[]
        + color: String
        + status: PresenceStatus
    }

    class CursorPosition {
        + x: Float
        + y: Float
        + objectId: UUID
    }

    class PresenceInfo {
        + userId: UUID
        + userName: String
        + status: PresenceStatus
        + cursor: CursorPosition
        + lastSeen: DateTime
    }

    enum PresenceStatus {
        ONLINE
        EDITING
        IDLE
        OFFLINE
    }
}

package "UI Components" {
    class LoginComponent extends Component {
        - authService: AuthService
        + handleLogin(email: string, password: string): void
    }

    class ProjectListComponent extends Component {
        - projectService: ProjectService
        - projects: Project[]
        + loadProjects(): void
        + handleCreateProject(): void
    }

    class EditorComponent extends Component {
        - editorController: EditorController
        - presenceService: PresenceService
        + initialize(projectId: UUID): void
        + handleToolChange(tool: String): void
    }

    class ToolbarComponent extends Component {
        - toolManager: ToolManager
        + handleToolSelect(toolName: String): void
    }

    class CollaboratorsPanel extends Component {
        - presenceService: PresenceService
        - users: RemoteUser[]
        + updateUsers(users: RemoteUser[]): void
    }
}

package "API Client" {
    class ApiClient {
        - baseUrl: String
        - authService: AuthService
        + get(endpoint: String): Promise<any>
        + post(endpoint: String, data: any): Promise<any>
        + put(endpoint: String, data: any): Promise<any>
        + delete(endpoint: String): Promise<any>
        - getHeaders(): Headers
    }
}

package "State Management" {
    class Store {
        - state: AppState
        - subscribers: Function[]
        + getState(): AppState
        + dispatch(action: Action): void
        + subscribe(callback: Function): void
        - reduce(state: AppState, action: Action): AppState
    }

    class AppState {
        + user: User
        + currentProject: Project
        + canvas: CanvasState
        + presence: PresenceState
    }

    class Action {
        + type: String
        + payload: any
    }
}

' Relationships - Main App
App "1" *-- "1" Router
App "1" *-- "1" AuthService
App "1" *-- "1" WebSocketClient
App "1" *-- "1" Store

Router "1" *-- "many" Component

' Authentication
AuthService ..> User

' WebSocket
WebSocketClient "1" *-- "1" ReconnectionManager

' Project Management
ProjectService ..> ApiClient
ProjectService ..> Project
Project "1" *-- "many" Participant
Participant --> ParticipantRole

' Collaborative Editing
EditorController "1" *-- "1" Canvas
EditorController "1" *-- "1" SelectionManager
EditorController "1" *-- "1" SyncService
EditorController "1" *-- "1" ToolManager

Canvas "1" *-- "many" CanvasObject
CanvasObject ..> ObjectType

ToolManager "1" *-- "many" Tool

SyncService "1" *-- "1" OTClient
SyncService --> WebSocketClient
SyncService ..> ChangeDelta

OTClient ..> ChangeDelta

PresenceService --> WebSocketClient
PresenceService "1" *-- "many" RemoteUser
PresenceService ..> PresenceInfo
RemoteUser "1" *-- "1" CursorPosition
RemoteUser --> PresenceStatus

PresenceInfo "1" *-- "1" CursorPosition
PresenceInfo --> PresenceStatus

' UI Components
LoginComponent --> AuthService
ProjectListComponent --> ProjectService
EditorComponent "1" *-- "1" EditorController
EditorComponent --> PresenceService
ToolbarComponent --> ToolManager
CollaboratorsPanel --> PresenceService

' API Client
ApiClient --> AuthService

' State Management
Store ..> AppState
Store ..> Action

@enduml

