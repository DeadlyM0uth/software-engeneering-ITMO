@startuml

title Диаграмма классов WebSocket-сервера

package "WebSocket Server" {
    class WebSocketServer {
        - port: int
        - connections: Map<UUID, Connection>
        - editingSessions: Map<UUID, EditingSession>
        + start(): void
        + stop(): void
        + handleConnection(socket: Socket): void
        + broadcast(projectId: UUID, message: Message, excludeId?: UUID): void
        + sendToUser(userId: UUID, message: Message): void
    }

    class Connection {
        - id: UUID
        - socket: Socket
        - userId: UUID
        - projectId: UUID
        - isAlive: boolean
        - lastActivity: DateTime
        + send(message: Message): void
        + close(): void
        + ping(): void
        + isActive(): boolean
    }

    class EditingSession {
        - id: UUID
        - projectId: UUID
        - participants: Set<UUID>
        - createdAt: DateTime
        - lastActivity: DateTime
        + addParticipant(userId: UUID): void
        + removeParticipant(userId: UUID): void
        + getActiveUsers(): UUID[]
        + isActive(): boolean
    }

    class MessageHandler {
        + handleMessage(connection: Connection, message: Message): void
        - routeMessage(type: MessageType, data: any): void
    }

    class SyncManager {
        - operationalTransform: OTEngine
        - conflictResolver: ConflictResolver
        + processEdit(edit: ChangeDelta): void
        + synchronizeChanges(projectId: UUID, changes: ChangeDelta[]): void
        + broadcastChanges(projectId: UUID, changes: ChangeDelta[]): void
        + resolveConflicts(operations: ChangeDelta[]): ChangeDelta[]
    }

    class PresenceManager {
        - userPresence: Map<UUID, PresenceInfo>
        + updatePresence(userId: UUID, status: PresenceStatus): void
        + getUsersInProject(projectId: UUID): PresenceInfo[]
        + notifyPresenceChange(projectId: UUID, userId: UUID): void
    }

    class SnapshotManager {
        - snapshotInterval: int
        - lastSnapshot: Map<UUID, DateTime>
        + shouldCreateSnapshot(projectId: UUID): boolean
        + createSnapshot(projectId: UUID, state: JSON): void
        + scheduleSnapshot(projectId: UUID): void
    }

    class ConflictResolver {
        + detectConflict(op1: ChangeDelta, op2: ChangeDelta): boolean
        + resolve(operations: ChangeDelta[]): ChangeDelta[]
        - applyTransformation(op: ChangeDelta, against: ChangeDelta): ChangeDelta
    }

    class OTEngine {
        - history: ChangeDelta[]
        + transform(clientOp: ChangeDelta, serverOps: ChangeDelta[]): ChangeDelta
        + apply(op: ChangeDelta, state: JSON): JSON
    }

    enum MessageType {
        EDIT
        SYNC
        PRESENCE
        CURSOR
        SNAPSHOT
        ACK
        ERROR
    }

    class Message {
        + type: MessageType
        + payload: any
        + timestamp: DateTime
        + userId: UUID
        + projectId: UUID
    }

    class ChangeDelta {
        + type: String
        + objectId: UUID
        + data: JSON
        + timestamp: DateTime
        + userId: UUID
    }

    class PresenceInfo {
        + userId: UUID
        + userName: String
        + status: PresenceStatus
        + cursor: CursorPosition
        + lastSeen: DateTime
    }

    class CursorPosition {
        + x: Float
        + y: Float
        + objectId: UUID
    }

    enum PresenceStatus {
        ONLINE
        EDITING
        IDLE
        OFFLINE
    }
}

package "Integration" {
    interface IStorageService {
        + saveSnapshot(projectId: UUID, data: JSON): Promise<void>
        + loadSnapshot(projectId: UUID): Promise<JSON>
    }

    interface IAuthService {
        + validateToken(token: String): Promise<User>
        + getUserPermissions(userId: UUID, projectId: UUID): Promise<Permissions>
    }

    interface ICanvasSyncService {
        + applyChange(projectId: UUID, delta: ChangeDelta): CanvasObject
        + resolveConflict(changes: ChangeDelta[]): ChangeDelta
        + createSnapshot(projectId: UUID): CanvasSnapshot
    }

    class User {
        + id: UUID
        + email: String
        + name: String
    }

    class Permissions {
        + canEdit: Boolean
        + canView: Boolean
        + canInvite: Boolean
    }
}

' Relationships
WebSocketServer "1" *-- "many" Connection
WebSocketServer "1" *-- "many" EditingSession
WebSocketServer "1" -- "1" MessageHandler
WebSocketServer "1" -- "1" SyncManager
WebSocketServer "1" -- "1" PresenceManager
WebSocketServer "1" -- "1" SnapshotManager

MessageHandler ..> Message
MessageHandler ..> MessageType
MessageHandler --> SyncManager
MessageHandler --> PresenceManager

SyncManager "1" *-- "1" OTEngine
SyncManager "1" *-- "1" ConflictResolver
SyncManager ..> ChangeDelta
SyncManager ..> Message
SyncManager ..> ICanvasSyncService

ConflictResolver ..> ChangeDelta
OTEngine ..> ChangeDelta

PresenceManager ..> PresenceInfo
PresenceManager ..> PresenceStatus

SnapshotManager ..> IStorageService
SnapshotManager ..> ICanvasSyncService
SnapshotManager --> SyncManager

Connection ..> Message
EditingSession ..> PresenceInfo

Message --> MessageType
PresenceInfo --> PresenceStatus
PresenceInfo "1" *-- "1" CursorPosition

WebSocketServer ..> IAuthService
WebSocketServer ..> IStorageService

IAuthService ..> User
IAuthService ..> Permissions

@enduml

